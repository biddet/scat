{% extends 'layout/page.html' %}
{% import 'macros.twig' as scat %}

{% block title %}
  PayPal Checkout @ Raw Materials Art Supplies
{% endblock %}

{% block content %}
  {% if person %}
    <h2>
      Welcome back{{ person ? ', ' ~ person.friendly_name }}!
      <small>
        (<a href="{{ url_for('account') }}">view your account</a>
        or <a href="{{ url_for('logout') }}">log out</a>)
      </small>
    </h2>
  {% else %}
    <h2>
      Welcome! <a href="{{ url_for('login')}}">Log in or create an account.</a>
    </h2>
  {% endif %}

  <form id="paypal-form" class="stacked-form">
    <label for="comment">Any special requests?</label>
    <textarea class="input" name="comment" rows="5"></textarea>
    {% if cart.shipping_address_id > 1 %}
      <small class="help-block">
        Please note that we are unable to pass along detailed delivery
        instructions on orders being shipped.
      </small>
    {% endif %}

    {% block cart %}
      <div id="cart">
        {% embed 'cart/cart.twig' with { 'editable' : false } %}
          {% block buttons %}
            {% import 'macros.twig' as scat %}
            <div class="pay-button">
              <div id="paypal-buttons"></div>
            </div>
          {% endblock %}
        {% endembed %}
      </div>
    {% endblock %}
  </form>

{% endblock %}

{% block extra_header %}
  <script src="https://www.paypal.com/sdk/js?client-id={{ paypal }}&amp;currency=USD&amp;disable-funding=card&amp;enable-funding=venmo{{ DEBUG ? '&debug=true' }}"></script>
{% endblock %}

{% block script %}
  <script>
    if (document.getElementById('paypal-buttons')) {
      paypal.Buttons({
        createOrder: (data, actions) => {
          return fetch("/cart/checkout/paypal-order", {
            headers: {
              'Accept': 'application/json',
            }
          })
          .then((res) => {
            if (!res.ok) {
              return res.json().then((data) => {
                if (data.text == 'Payment already completed.') {
                  window.location.href= '/sale/{{ cart.uuid }}/thanks';
                } else {
                  return Promise.reject(new Error(data.text));
                }
              })
            }
            return res.json()
          })
          .then((order) => {
            return order.id
          });
        },

        // Finalize the transaction on the server after payer approval
        onApprove: (data, actions) => {
	  return actions.order.capture().then(function(details) {
	    let formData= new FormData(document.getElementById('paypal-form'))
	    formData.append('order_id', details.id)
	    return fetch('{{ url_for('finalize-paypal') }}', {
	      method: 'POST',
	      body: formData
	    }).then(function (data) {
	      if (data.ok) {
		window.location.href= '{{ url_for('sale-thanks', { uuid: cart.uuid }) }}'
	      }
	    });
	  });
        }
      }).render('#paypal-buttons');
    }
  </script>
{% endblock %}
