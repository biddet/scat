{% extends 'layout/page.html' %}
{% import 'macros.twig' as scat %}

{% block title %}
  Shopping Cart @ Raw Materials Art Supplies
{% endblock %}

{% block content %}
  {% if person %}
    <h2>
      Welcome back{{ person ? ', ' ~ person.friendly_name }}!
      <small>
        (<a href="{{ url_for('account') }}">view your account</a>
        or <a href="{{ url_for('logout') }}">log out</a>)
      </small>
    </h2>
  {% else %}
    <h2>
      Welcome! <a href="{{ url_for('login')}}">Log in or create an account.</a>
    </h2>
  {% endif %}

  {% set items= cart.items.find_many() %}
  {% if not items|length %}
    <div class="alert alert-warning">
      <b>You don't have anything in your cart.</b>
      You can <a href="{{ url_for('catalog') }}">start browsing for art
      supplies</a> or use the search form at the top of the page to find
      what you need.
    </div>

    {# XXX show some popular products #}
  {% else %}
    {% embed 'cart/cart.twig' %}
      {% block buttons %}
        <div class="pay-button">
          <a class="button block" href="{{ url_for('checkout-stripe' ) }}">
            <i class="lni lni-credit-cards"></i>
            <span class="label">Pay with Credit Card</span>
          </a>
        </div>
        <div class="pay-button">
          <a class="button block" href="{{ url_for('checkout-paypal' ) }}"
             style="--primary-color: #253B80">
            <i class="lni lni-paypal"></i>
            <span class="label">Pay with PayPal</span>
          </a>
        </div>
        <div class="pay-button">
          <div id="AmazonPayButton"></div>
        </div>
      {% endblock %}
    {% endembed %}
  {% endif %}

  <div class="well">
    <p>Want to retrieve a cart that you saved? Enter your email address and
    we'll email you a link to access it.</p>

    <form class="stacked-form"
          method="POST" action="{# url_for('cart-retrieve') #}">
      <label for="email">
        Email
      </label>
      <input type="email" class="input" name="email">
      <button role="submit" class="button">
        <i class="lni lni-cart"></i>
        <span class="label">Retrieve Saved Cart</span>
      </button>
    </form>
  </div>
{% endblock %}

{% block script %}
  {% if amzn.merchant_id %}
    <script src="https://static-na.payments-amazon.com/checkout.js"></script>
    <script type="text/javascript" charset="utf-8">
      let amazonPayButton= amazon.Pay.renderButton('#AmazonPayButton', {
        merchantId: '{{ amzn.merchant_id }}',
        ledgerCurrency: 'USD',
        {% if DEBUG %}
          sandbox: true,
        {% endif %}
        checkoutLanguage: 'en_US',
        productType: 'PayAndShip',
        placement: 'Cart',
        buttonColor: 'Gold',
      })

      amazonPayButton.onClick(() => {
        /* TODO fire ecommerce event */
        amazonPayButton.initCheckout({
          createCheckoutSessionConfig: {
            payloadJSON: '{{ amzn.payload | raw }}',
            signature: '{{ amzn.signature }}',
            publicKeyId: '{{ amzn.public_key_id }}'
          }
        })
      })
    </script>
  {% endif %}
{% endblock %}
