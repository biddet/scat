<?
require 'scat.php';
require 'lib/txn.php';

$id= (int)$_REQUEST['id'];

$type= $_REQUEST['type'];
$number= (int)$_REQUEST['number'];

if (!$id && $type) {
  $q= "SELECT id FROM txn
        WHERE type = '". $db->real_escape_string($type) ."'
          AND number = $number";
  $r= $db->query($q);

  if (!$r->num_rows)
      die("<h2>No such transaction found.</h2>");

  $row= $r->fetch_row();
  $id= $row[0];
}

if (!$id) die("no transaction specified.");

$txn= txn_load_full($db, $id);

if ($txn['txn']['type'] == 'customer') {
  header("Location: ./?id=" . $id);
  exit;
}

head("Transaction @ Scat", true);

?>
<form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="number" class="col-sm-2 control-label">Number</label>
    <div class="col-sm-8">
      <p class="form-control-static" id="number"
         data-bind="text: txn.formatted_number"></p>
    </div>
  </div>
  <div class="form-group">
    <label for="created" class="col-sm-2 control-label">Created</label>
    <div class="col-sm-8">
      <p class="form-control-static" id="created"
         data-bind="text: txn.created"></p>
    </div>
  </div>
  <div class="form-group">
    <label for="person" class="col-sm-2 control-label">Person</label>
    <div class="col-sm-8">
      <p class="form-control-static" id="person">
        <a data-bind="text: txn.person_name, 
                      attr: { href: '/person/' + txn.person() }">
        </a>
      </p>
    </div>
  </div>
  <div class="form-group">
    <label for="ordered" class="col-sm-2 control-label">Ordered</label>
    <div class="col-sm-8">
      <p class="form-control-static" id="ordered"
         data-bind="text: txn.ordered"></p>
    </div>
  </div>
  <div class="form-group">
    <label for="allocated" class="col-sm-2 control-label">Allocated</label>
    <div class="col-sm-8">
      <span class="form-control-static" id="allocated"
         data-bind="text: txn.allocated"></span>
      <button class="btn btn-default btn-sm"
         data-bind="visible: txn.ordered() != txn.allocated(),
                    click: allocateAll">
        Allocate
      </button>
      <button class="btn btn-default btn-sm"
         data-bind="visible: txn.ordered() != txn.allocated(),
                    click: closeAll">
        Close
      </button>
      <button class="btn btn-default btn-sm"
         data-bind="visible: txn.ordered() == txn.allocated(),
                    click: openAll">
        Unallocate
      </button>
    </div>
  </div>
</form>

<table class="table table-striped table-condensed"
       data-bind="visible: items()">
  <thead>
    <tr>
      <th class="num">#</th>
      <th>Code</th>
      <th>Name</th>
      <th>Price</th>
      <th>Discount</th>
      <th>Ordered</th>
      <th>Allocated</th>
    </tr>
  </thead>
  <tbody data-bind="foreach: items">
    <tr>
      <td class="num"><span data-bind="text: $index() + 1"></span></td>
      <td>
        <a data-bind="text: $data.code,
                      attr: { href: 'item.php?code=' + $data.code() }">
        </a>
      </td>
      <td><span data-bind="text: $data.name"></span></td>
      <td><span data-bind="text: amount($data.price())"></span></td>
      <td><span data-bind="text: $data.discount"></span></td>
      <td>
        <span id="quantity" data-bind="jeditable: $data.quantity, jeditableOptions: { onupdate: $parent.updateLine, line: $data, onblur: 'cancel', width: '3em', select: true }"></span>
      </td>
      <td>
        <span id="allocated" data-bind="jeditable: $data.allocated, jeditableOptions: { onupdate: $parent.updateLine, line: $data, onblur: 'cancel', width: '3em', select: true }"></span>
        <button class="btn btn-default btn-xs"
           data-bind="visible: $data.quantity() != $data.allocated(),
                      click: $parent.allocateLine">
          Allocate
        </button>
        <button class="btn btn-default btn-xs"
           data-bind="visible: $data.quantity() != $data.allocated(),
                      click: $parent.closeLine">
          Close
        </button>
      </td>
    </tr>
  </tbody>
</table>
<script>
var model= <?=json_encode($txn)?>;

var viewModel= ko.mapping.fromJS(model);

viewModel.allocateAll= function() {
  $.getJSON("api/txn-allocate.php?callback=?",
            { txn: viewModel.txn.id() },
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
            });
}

viewModel.allocateLine= function(line) {
  $.getJSON("api/txn-allocate.php?callback=?",
            { txn: viewModel.txn.id(), line: line.line_id() },
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              var top= document.documentElement.scrollTop || document.body.scrollTop;
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
              document.documentElement.scrollTop= document.body.scrollTop= top;
            });
}

viewModel.closeAll= function() {
  $.getJSON("api/txn-close.php?callback=?",
            { txn: viewModel.txn.id() },
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
            });
}

viewModel.closeLine= function(line) {
  $.getJSON("api/txn-close.php?callback=?",
            { txn: viewModel.txn.id(), line: line.line_id() },
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              var top= document.documentElement.scrollTop || document.body.scrollTop;
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
              document.documentElement.scrollTop= document.body.scrollTop= top;
            });
}

viewModel.openAll= function() {
  $.getJSON("api/txn-open.php?callback=?",
            { txn: viewModel.txn.id() },
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
            });
}

viewModel.updateLine= function (value, settings) {
  var data= { txn: viewModel.txn.id(), id: settings.line.line_id() };
  data[this.id]= value;

  $.getJSON("api/txn-update-item.php?callback=?",
            data,
            function (data) {
              if (data.error) {
                Scat.alert(data);
                return;
              }
              ko.mapping.fromJS({ txn: data.txn, items: data.items },
                                viewModel);
            });
  return value;
}

ko.applyBindings(viewModel);
</script>
<?
if ($txn['txn']['type'] == 'vendor') {
?>
<div id="upload-status" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Results</h4>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>
<script>
$("body").html5Uploader({
  name: 'src',
  postUrl: 'api/txn-upload-items.php?txn=<?=$id?>',
  onSuccess: function(e, file, response) {
    data= $.parseJSON(response);
    if (data.error) {
      Scat.alert(data);
      return;
    }
    ko.mapping.fromJS({ txn: data.txn, items: data.items },
                      viewModel);
    $('#upload-status .modal-body').append(data.result);
    $('#upload-status').modal('show');
  },
  onServerError: function(e, file) {
    Scat.alert("File upload failed.");
  },
});
</script>
<?
}

if ($txn['meta'] == 'customer') {
?>
<button id="receipt" class="btn btn-default">Print Receipt</button>
<script>
$("#receipt").on('click', function() {
  Scat.print('receipt', { id: <?=$id?> });
});
</script>
<?
}

if ($txn['txn']['type'] == 'vendor') {
?>
<button id="print-product-labels" class="btn btn-default">
  Print Product Labels
</button>
<script>
$("#print-product-labels").on('click', function() {
  Scat.print('labels-product', { id: <?=$id?> });
});
</script>
<button id="export-order" class="btn btn-default">
  Export Order
</button>
<script>
$("#export-order").on('click', function() {
  window.location.href= 'export/txn.php?dl=1&id=<?=$id?>';
});
</script>
<?
}

if (preg_match('/customer/', $txn['Number$txn'])) {
  echo '<h2>Payments</h2>';
  $q= "SELECT id AS meta,
              processed AS Date,
              method AS Method\$payment,
              amount AS Amount\$dollar
         FROM payment
        WHERE txn = $id
        ORDER BY processed ASC";
  dump_table($db->query($q));
  dump_query($q);
}

echo '<h2>Notes</h2>';
$q= "SELECT id AS meta,
            added AS Date,
            content AS Note
       FROM note
      WHERE kind = 'txn' AND attach_id = $id
      ORDER BY added ASC";
dump_table($db->query($q));
dump_query($q);
?>
<div id="dropoverlay" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 3000; background: rgba(0,0,0,0.5); display: none">
  <div style="width: 80%; height: 80%; margin: 10%; padding: 10%; position: fixed; top: 0; left: 0; border: 3px dashed white; border-radius: 25px;">
    <h1 style="color: #fff">Drop file here.</h1>
  </div>
</div>
<script>
$('body').on('dragbetterenter', function () {
  $('#dropoverlay').show();
});
$('body').on('dragbetterleave', function () {
  $('#dropoverlay').hide();
});

</script>
<?
foot();
